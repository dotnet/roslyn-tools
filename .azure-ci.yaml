# Branches that trigger a build on commit
trigger:
- main

# Branches that trigger builds on PR
pr:
  branches:
    include:
    - main
  paths:
    exclude:
      - src/GitHubCreateMergePRs/config.xml

variables:
  # Set pool / queue name variables depending on which instance we're running in.
  - name: PoolName
    ${{ if eq(variables['System.TeamProject'], 'public') }}:
      value: NetCore-Public
    ${{ else }}:
      value: NetCore1ESPool-Internal

  - name: WindowsQueueName
    ${{ if eq(variables['System.TeamProject'], 'public') }}:
      value: 1es-windows-2022-open
    ${{ else }}:
      value: 1es-windows-2022

  - name: UbuntuQueueName
    ${{ if eq(variables['System.TeamProject'], 'public') }}:
      value: Build.Ubuntu.2204.Amd64.Open
    ${{ else }}:
      value: Build.Ubuntu.2204.Amd64

jobs:
- job: Windows
  pool:
    name: $(PoolName)
    demands: ImageOverride -equals $(WindowsQueueName)
  strategy:
    maxParallel: 2
    matrix:
      debug:
        _configuration: Debug
      release:
        _configuration: Release
  steps:
  - script: .\eng\common\CIBuild.cmd -configuration $(_configuration) -prepareMachine  /p:DotnetPublishUsingPipelines=true

  - task: PublishTestResults@2
    displayName: Publish xUnit Test Results
    inputs:
      testRunner: XUnit
      testResultsFiles: '$(Build.SourcesDirectory)\artifacts\TestResults\$(_configuration)\*.xml'
      mergeTestResults: true
      testRunTitle: 'Test Windows $(_configuration)'
    condition: always()

  - task: PublishPipelineArtifact@1
    displayName: Publish Logs
    inputs:
      targetPath: '$(Build.SourcesDirectory)/artifacts/log/$(_configuration)'
      artifactName: 'Windows $(_configuration) Logs - $(System.JobAttempt)'
    continueOnError: true
    condition: not(succeeded())

- job: Linux
  pool:
    name: $(PoolName)
    demands: ImageOverride -equals $(UbuntuQueueName)
  strategy:
    maxParallel: 2
    matrix:
      debug:
        _configuration: Debug
      release:
        _configuration: Release
  steps:
  - script: ./eng/common/cibuild.sh --configuration $(_configuration) --prepareMachine /p:DotnetPublishUsingPipelines=true

  - task: PublishTestResults@2
    displayName: Publish xUnit Test Results
    inputs:
      testRunner: XUnit
      testResultsFiles: '$(Build.SourcesDirectory)/artifacts/TestResults/$(_configuration)/*.xml'
      mergeTestResults: true
      testRunTitle: 'Test Linux $(_configuration)'
    condition: always()

  - task: PublishPipelineArtifact@1
    displayName: Publish Logs
    inputs:
      targetPath: '$(Build.SourcesDirectory)/artifacts/log/$(_configuration)'
      artifactName: 'Linux $(_configuration) Logs - $(System.JobAttempt)'
    continueOnError: true
    condition: not(succeeded())
