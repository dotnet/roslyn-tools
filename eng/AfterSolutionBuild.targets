<Project>
  <ItemGroup>
    <SymbolPackages Include="$(ArtifactsNonShippingPackagesDir)\*.symbols.nupkg" Exclude="@(StableVersionPackages)" />
  </ItemGroup>

  <!-- Removes files from the `*.symbols.nupkg` packages that cause errors with symbol publishing. -->
  <Target Name="StripFilesFromSymbolPackages" AfterTargets="Pack">
    <ItemGroup>
      <SymbolPackageWithBadFiles Include="$(ArtifactsNonShippingPackagesDir)\Microsoft.Roslyn.*.symbols.nupkg" />
      <SymbolPackageFilesToStrip Include="tools/netcoreapp3.1/any/runtimes/*/native/libgit*.so" />
    </ItemGroup>
    <PropertyGroup>
      <PackageTempPath>$([System.IO.Path]::GetTempPath())/$([System.Guid]::NewGuid())</PackageTempPath>
    </PropertyGroup>

    <MakeDir Directories="$(PackageTempPath)" />
    <Unzip SourceFiles="%(SymbolPackageWithBadFiles.Identity)" DestinationFolder="$(PackageTempPath)" />
    <Delete Files="$(PackageTempPath)\%(SymbolPackageFilesToStrip.Identity)" />
    <ZipDirectory SourceDirectory="$(PackageTempPath)" DestinationFile="%(SymbolPackageWithBadFiles.Identity)" Overwrite="true" />
    <RemoveDir Directories="$(PackageTempPath)" />
  </Target>

</Project>
